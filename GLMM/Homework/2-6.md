### **문제 분석 및 모델 설정**

이 문제는 3년 무병 생존 여부(Disease-Free, 이항 변수)를 세 가지 예측 변수(Lymphocytic Infiltration, Gender, Osteoblastic Pathology, 모두 범주형)로 설명하는 것입니다.

*   **반응 변수 (Y)**: 무병 생존 여부 (Yes=1, No=0)
*   **설명 변수**:
    *   **L (Lymphocytic Infiltration)**: High, Low
    *   **G (Gender)**: Female, Male
    *   **O (Osteoblastic Pathology)**: Yes, No

### **a. 각 예측변수를 개별적으로 고려했을 때, 모두 유의한 효과를 가지는지 보여라.**

#### **식 (Formulation)**

각 예측 변수의 효과를 개별적으로 보기 위해, 세 개의 단순 로지스틱 회귀 모델을 적합시킵니다. 각 모델은 예측 변수 하나만을 포함합니다.
1.  **모델 L**: $\text{logit}[P(Y=1)] = \alpha + \beta_L L$
2.  **모델 G**: $\text{logit}[P(Y=1)] = \alpha + \beta_G G$
3.  **모델 O**: $\text{logit}[P(Y=1)] = \alpha + \beta_O O$

각 모델에서 귀무가설 $H_0: \beta=0$에 대한 가능도비 검정(Likelihood Ratio Test) 또는 왈드 검정(Wald Test)을 수행하여 P-값을 확인합니다.

#### **R 코드 (R Code)**

```R
# 1. 데이터 입력
# 데이터가 요약된 형태이므로, 각 조합에 대한 성공/실패 횟수로 변환
survival_data <- data.frame(
  Lymphocytic = factor(c("High", "High", "High", "High", "Low", "Low", "Low", "Low")),
  Gender = factor(c("Female", "Female", "Male", "Male", "Female", "Female", "Male", "Male")),
  Osteoblastic = factor(rep(c("No", "Yes"), 4)),
  Disease_Free_Yes = c(3, 2, 4, 1, 5, 3, 5, 6),
  Disease_Free_No = c(0, 0, 0, 0, 0, 2, 4, 11)
)

# 2. 각 예측 변수에 대한 단순 로지스틱 회귀 모델 적합 및 검정

# 모델 L: Lymphocytic Infiltration
model_L_only <- glm(cbind(Disease_Free_Yes, Disease_Free_No) ~ Lymphocytic, 
                    data = survival_data, family = binomial)
print("--- a. Lymphocytic Infiltration 효과 검정 ---")
print(anova(update(model_L_only, . ~ 1), model_L_only, test="LRT"))


# 모델 G: Gender
model_G_only <- glm(cbind(Disease_Free_Yes, Disease_Free_No) ~ Gender, 
                    data = survival_data, family = binomial)
print("--- a. Gender 효과 검정 ---")
print(anova(update(model_G_only, . ~ 1), model_G_only, test="LRT"))


# 모델 O: Osteoblastic Pathology
model_O_only <- glm(cbind(Disease_Free_Yes, Disease_Free_No) ~ Osteoblastic, 
                    data = survival_data, family = binomial)
print("--- a. Osteoblastic Pathology 효과 검정 ---")
print(anova(update(model_O_only, . ~ 1), model_O_only, test="LRT"))

```

### **b. 세 예측변수를 모두 포함하는 main-effect 로지스틱 회귀모형을 적합하여라. 이때 lymphocytic infiltration 효과의 MLE가 무한대가 되는 이유를 설명하여라.**

#### **식 (Formulation)**

1.  **주효과 모델(Main-effect Model)**:

$$ \text{logit}[P(Y=1)] = \alpha + \beta_L L + \beta_G G + \beta_O O $$

    이 모델은 세 변수의 주효과만을 고려하고 상호작용은 없다고 가정합니다.

2.  **무한대 추정치(Infinite Estimates)의 원인**:
    로지스틱 회귀에서 MLE가 무한대로 발산하는 경우는 데이터에 **완전 분리(complete separation)** 또는 **준-완전 분리(quasi-complete separation)**가 존재할 때 발생합니다.
    *   **완전 분리**: 예측 변수의 어떤 선형 결합을 사용하여 반응 변수의 결과(0 또는 1)를 완벽하게 예측할 수 있는 경우.
    *   **준-완전 분리**: 완벽하지는 않지만, 특정 예측 변수 수준에서 한 가지 결과만 나타나는 경우.

    데이터를 살펴보면, 'Lymphocytic Infiltration'이 'High'인 모든 환자(Female/Male, Osteo Yes/No)의 'Disease-Free' 결과가 'No'인 경우가 0명입니다. 즉,
    **If Lymphocytic = High, then Disease-Free = Yes (확률 100%).**
    이것이 준-완전 분리의 한 형태입니다. 로지스틱 회귀 모델은 이 100% 확률에 해당하는 로그-오즈 값($\log(1/0) = \infty$)을 예측하려고 시도하기 때문에, 'Lymphocytic' 변수와 관련된 계수의 MLE가 무한대로 발산하게 됩니다.

#### **R 코드 (R Code)**

```R
# 1. 주효과 로지스틱 회귀 모델 적합
main_effect_model <- glm(cbind(Disease_Free_Yes, Disease_Free_No) ~ Lymphocytic + Gender + Osteoblastic,
                         data = survival_data, 
                         family = binomial)

# 2. 모델 적합 결과 확인
# R의 glm 함수는 무한대 추정치가 발생하면 매우 큰 계수와 표준오차, 그리고 경고 메시지를 출력합니다.
print("b. 주효과 모델 적합 결과")
print(summary(main_effect_model))
```

### **c. 조건부 로지스틱 회귀분석을 이용하여, (i) 다른 변수를 통제한 상태에서 lymphocytic infiltration 효과에 대한 정확검정을 수행하고, (ii) 효과에 대한 95% 신뢰구간을 구하여라.**

#### **식 (Formulation)**

준-완전 분리로 인해 일반적인 로지스틱 회귀의 MLE가 존재하지 않을 때, **정확 조건부 로지스틱 회귀(Exact Conditional Logistic Regression)**를 사용합니다. 이 방법은 희소 데이터(sparse data)나 분리 현상이 있을 때 신뢰할 수 있는 추론을 제공합니다.

1.  **조건부 우도(Conditional Likelihood)**:
    이 방법은 모델의 절편($\alpha$)과 다른 교란 변수(Gender, Osteoblastic)의 효과($\beta_G, \beta_O$)를 **방해 모수(nuisance parameters)**로 취급합니다. 이 방해 모수들에 대한 충분통계량(sufficient statistics)에 대해 조건화하여, 이들을 우도 함수에서 제거합니다. 그 결과, 오직 우리가 관심 있는 모수($\beta_L$)에만 의존하는 **조건부 우도 함수**가 만들어집니다.

2.  **정확 검정(Exact Test)**:
    이 조건부 우도에 기반하여 $H_0: \beta_L=0$에 대한 **정확한(exact) P-값**을 계산합니다. 이는 대푯본 근사를 사용하지 않습니다.

3.  **정확 신뢰구간(Exact Confidence Interval)**:
    검정의 역산 원리를 이용하여 $\beta_L$에 대한 95% 신뢰구간을 구합니다. 즉, $H_0: \beta_L=\beta_{L0}$ 검정을 기각하지 못하는 모든 $\beta_{L0}$ 값들의 집합을 찾습니다.

#### **R 코드 (R Code)**

정확 조건부 로지스틱 회귀는 기본 `glm` 함수로는 수행할 수 없으며, `elrm` 패키지나 `logistf` 패키지 등을 사용해야 합니다. 여기서는 `elrm` 패키지를 사용하겠습니다. 데이터 형식을 각 환자별 데이터(개별 데이터)로 변환해야 합니다.

```R
# 0. 필요한 패키지 설치 및 로드
# install.packages("elrm") 
library(elrm)
# install.packages("dplyr")
library(dplyr)
# install.packages("tidyr")
library(tidyr)


# 1. 데이터를 개별 데이터(ungrouped) 형태로 변환
ungrouped_data <- survival_data %>%
  # 각 행에 대해 성공(1)과 실패(0) 데이터 생성
  mutate(Yes_data = mapply(rep, 1, Disease_Free_Yes, SIMPLIFY = FALSE),
         No_data = mapply(rep, 0, Disease_Free_No, SIMPLIFY = FALSE)) %>%
  # 리스트를 하나의 열로 합침
  pivot_longer(cols = c(Yes_data, No_data), names_to = NULL, values_to = "Disease_Free_list") %>%
  # 리스트를 행으로 펼침
  unnest(cols = c(Disease_Free_list)) %>%
  # 최종 데이터 선택
  select(Lymphocytic, Gender, Osteoblastic, Disease_Free = Disease_Free_list)

# 2. 정확 조건부 로지스틱 회귀 모델 적합
# elrm 함수의 'interest' 인자에 관심 변수를 지정
exact_model <- elrm(Disease_Free ~ Lymphocytic + Gender + Osteoblastic, 
                    interest = ~ Lymphocytic,
                    dataset = ungrouped_data)

# 3. 결과 출력
# (i) 효과에 대한 정확 검정 결과
# (ii) 효과에 대한 95% 신뢰구간
print("c. 정확 조건부 로지스틱 회귀 결과")
print(summary(exact_model))
```
